@page "/"
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KubernetesToDo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>KubernetesToDo</h1>
        <small id="status" class="text-muted">API: /api/todo</small>
      </div>

      <form id="addForm" class="input-group mb-3">
        <input id="title" type="text" class="form-control" placeholder="New task title" required>
        <button class="btn btn-primary" type="submit">Add</button>
      </form>

      <ul id="todoList" class="list-group">
        <!-- items inserted here -->
      </ul>
    </div>

    <script>
      const apiBase = '/api/todo';

      async function loadTodos(){
        const res = await fetch(apiBase);
        const items = await res.json();
        const list = document.getElementById('todoList');
        list.innerHTML = '';
        if(!items || items.length === 0){
          list.innerHTML = '<li class="list-group-item text-muted">No tasks</li>';
          return;
        }
        for(const it of items){
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const left = document.createElement('div');
          left.innerHTML = `<div><input class=\"form-check-input me-2\" type=\"checkbox\" ${it.isCompleted ? 'checked' : ''} data-id=\"${it.id}\"> <strong>${escapeHtml(it.title)}</strong> <small class=\"text-muted ms-2\">${new Date(it.createdAt).toLocaleString()}</small></div>`;
          const right = document.createElement('div');
          right.innerHTML = `<button class=\"btn btn-sm btn-danger me-2\" data-delete=\"${it.id}\">Delete</button>`;
          li.appendChild(left);
          li.appendChild(right);
          list.appendChild(li);
        }
      }

      function escapeHtml(unsafe) {
        return unsafe
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      document.getElementById('addForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const title = document.getElementById('title').value.trim();
        if(!title) return;
        await fetch(apiBase, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title }) });
        document.getElementById('title').value = '';
        await loadTodos();
      });

      document.getElementById('todoList').addEventListener('click', async (e)=>{
        const del = e.target.closest('[data-delete]');
        if(del){
          const id = del.getAttribute('data-delete');
          await fetch(`${apiBase}/${id}`, { method: 'DELETE' });
          await loadTodos();
          return;
        }
        const chk = e.target.closest('input[type=checkbox]');
        if(chk){
          const id = chk.getAttribute('data-id');
          const isCompleted = chk.checked;
          await fetch(`${apiBase}/${id}/complete`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ isCompleted }) });
          await loadTodos();
        }
      });

      // initial load
      loadTodos().catch(err=>{
        document.getElementById('status').textContent = 'API unreachable';
        console.error(err);
      });
    </script>
  </body>
</html>
